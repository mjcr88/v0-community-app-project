# Build Log: Admin Family Selection Improvement
**Issue:** #72 | **Date:** 2026-02-12 | **Status:** In Progress

## Context
- **PRD Link**: `docs/07-product/03_prds/prd_2026-02-02_sprint_1_security_polish.md`
- **Req Link**: `docs/07-product/02_requirements/requirements_2026-01-27_admin_family_selection.md`
- **Board Status**: Issue #72 moved to In Progress.

## Clarifications (Socratic Gate)
- **Override Behavior**: User confirmed that "Override" means "Unlink existing residents from lot" (clearing the lot for new resident), NOT deleting the family.
- **Family Assignment**: User confirmed the desired flow: If lot is occupied, ask "Add to Existing Family?" OR "Create Independent Resident?".
- **Household Bug**: User reported "Add Existing Member" in Household Settings fails to save.
    - **Investigation**: Confirmed `family-management-form.tsx` uses client-side `update()` which fails RLS.
    - **Fix**: Will add `addExistingFamilyMember` Server Action.

## Progress Log
- **2026-02-12**: Initialized worklog and branch `feat/72-admin-family-selection`.
- **2026-02-12 [Research]**: Analyzed `create-resident-form.tsx` and `app/actions/families.ts`. Identified missing server action for adding existing members.

## Handovers
- **2026-02-12 [13:25]**: `orchestrator` completed Planning. Passing to `backend-specialist` for Shared Data Access & Server Actions.
  - **Context**: Need `useFamilyByLot` hook for Admin UI and `addExistingFamilyMember` action for Household Settings.
- **2026-02-12 [13:35]**: `backend-specialist` completed tasks. Passing to `frontend-specialist` for UI Implementation.
  - **Completed**: `app/actions/families.ts` (added `addExistingFamilyMember`), `hooks/admin/use-family-by-lot.ts` (created).
  - **Next**: Wire up `create-resident-form.tsx` and `family-management-form.tsx`.

## Blockers & Errors
<!-- Issues encountered -->

## Decisions
<!-- Technical decisions made -->

## Lessons Learned
<!-- Candidates for nido_patterns.md -->
### [2026-02-13] PR Feedback & Fixes
- **Migration Gap**: Added `20260212000002_add_is_tenant_admin_func.sql` (missing dependency for RLS fix).
- **Onboarding UX**: Preserved `onboarding_completed` state when adding existing users to families (preventing forced re-onboarding).
- **Safety**: Added guards for empty `existingResidents` array.

## Production Migration Plan
> **CRITICAL**: These migrations MUST be applied in order after merging.

1.  `20260212000002_add_is_tenant_admin_func.sql`: Adds helper function.
2.  `20260212000003_fix_users_rls_recursion.sql`: Fixes RLS recursion.

## Build Summary
- **Features**: 
  - Admin: Auto-select family by lot.
  - Admin: Explicit "Add to Family", "Create Independent", "Unlink" options.
  - Household: Fix "Add Existing Member" (RLS bypass).
- **Fixes**:
  - Resolved "infinite recursion" in `users` RLS policies.
